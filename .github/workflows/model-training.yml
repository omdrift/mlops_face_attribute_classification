name: Model Training

on:
  workflow_dispatch:
    inputs:
      epochs:
        description: 'Number of training epochs'
        required: true
        default: '10'
        type: string
      batch_size:
        description: 'Batch size'
        required: true
        default: '32'
        type: string
      learning_rate:
        description: 'Learning rate'
        required: true
        default: '0.001'
        type: string

jobs:
  train:
    name: Train Model
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Pull data with DVC
        run: |
          pip install dvc
          dvc pull || echo "Using local data"

      - name: Train model
        env:
          EPOCHS: ${{ github.event.inputs.epochs }}
          BATCH_SIZE: ${{ github.event.inputs.batch_size }}
          LEARNING_RATE: ${{ github.event.inputs.learning_rate }}
        run: |
          echo "Training with:"
          echo "  Epochs: $EPOCHS"
          echo "  Batch size: $BATCH_SIZE"
          echo "  Learning rate: $LEARNING_RATE"
          
          # Update params if needed
          python src/training/train.py

      - name: Save training artifacts
        uses: actions/upload-artifact@v3
        with:
          name: model-artifacts
          path: |
            models/
            metrics/
            training_curves.png
            accuracy_curves.png

  evaluate:
    name: Evaluate Model
    runs-on: ubuntu-latest
    needs: train
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download model artifacts
        uses: actions/download-artifact@v3
        with:
          name: model-artifacts

      - name: Evaluate model
        run: |
          python src/evaluation/evaluate.py || echo "Evaluation script not found"

      - name: Display metrics
        run: |
          if [ -f metrics/train_metrics.json ]; then
            echo "Training metrics:"
            cat metrics/train_metrics.json
          fi

  upload-artifacts:
    name: Upload Model Artifacts
    runs-on: ubuntu-latest
    needs: [train, evaluate]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          name: model-artifacts

      - name: Create release tag
        id: tag
        run: |
          TAG="model-$(date +'%Y%m%d-%H%M%S')"
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Upload to release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Model ${{ steps.tag.outputs.tag }}
          files: |
            models/best_model.pth
            metrics/train_metrics.json
          body: |
            Automated model training completed
            
            Training parameters:
            - Epochs: ${{ github.event.inputs.epochs }}
            - Batch size: ${{ github.event.inputs.batch_size }}
            - Learning rate: ${{ github.event.inputs.learning_rate }}
