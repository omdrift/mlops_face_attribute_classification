name: Model Training

on:
  workflow_dispatch:
    inputs:
      epochs:
        description: 'Number of training epochs'
        required: true
        default: '10'
        type: string
      batch_size:
        description: 'Batch size for training'
        required: true
        default: '32'
        type: string
      learning_rate:
        description: 'Learning rate'
        required: false
        default: '0.001'
        type: string

permissions:
  contents: read

jobs:
  train-model:
    name: Train ML Model
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
      
      - name: Configure MLflow
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
        run: |
          echo "MLflow tracking URI configured"
          echo "MLFLOW_TRACKING_URI=${MLFLOW_TRACKING_URI}" >> $GITHUB_ENV
      
      - name: Update training parameters
        run: |
          # Update params.yaml with input parameters
          sed -i "s/epochs:.*/epochs: ${{ github.event.inputs.epochs }}/" params.yaml
          sed -i "s/batch_size:.*/batch_size: ${{ github.event.inputs.batch_size }}/" params.yaml
          cat params.yaml
      
      - name: Pull data with DVC
        run: |
          dvc pull data/raw.dvc || echo "Data pull skipped"
      
      - name: Run training
        run: |
          python src/training/train.py
      
      - name: Upload model artifact
        uses: actions/upload-artifact@v3
        with:
          name: trained-model
          path: |
            models/best_model.pth
            metrics/train_metrics.json
          retention-days: 30
      
      - name: Comment training results
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let metricsContent = 'Training completed!';
            
            try {
              const metrics = JSON.parse(fs.readFileSync('metrics/train_metrics.json', 'utf8'));
              metricsContent = `
              ## Training Results
              
              **Parameters:**
              - Epochs: ${{ github.event.inputs.epochs }}
              - Batch Size: ${{ github.event.inputs.batch_size }}
              - Learning Rate: ${{ github.event.inputs.learning_rate }}
              
              **Metrics:**
              \`\`\`json
              ${JSON.stringify(metrics, null, 2)}
              \`\`\`
              `;
            } catch (error) {
              console.log('Metrics file not found or invalid');
            }
            
            console.log(metricsContent);
